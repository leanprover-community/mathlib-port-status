{% extends "layout.j2" %}
{% import 'progress.j2' as progress -%}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{site_url}}/hljs-light.css">
<link rel="stylesheet" href="{{site_url}}/hljs-dark.css">
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js"></script>
<script src="https://unpkg.com/d3-dag@0.11.1"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="{{site_url}}/graph.js"></script>
<script>hljs.highlightAll();</script>
{% endblock %}

{%block title %}{{mathlib3_import|join('.')}} | {{super()}}{% endblock %}

{% block nav %}
{{ super() }}
<div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href="old">alternate view</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="out-of-sync">out of sync</a>
        </li>
    </ul>
</div>
{% endblock %}

{% block body %}

<h1>
    <a href="https://leanprover-community.github.io/mathlib_docs/{{mathlib3_import|join('/')}}"><code>{{mathlib3_import|join('.')}}</code></a> ‚ü∑
    {% if data.status.ported %}
    <a href="https://leanprover-community.github.io/mathlib4_docs/{{mathlib4_import|join('/')}}"><code>{{mathlib4_import|join('.')}}</code></a>
    {% elif mathlib4_import is not none %}
    <code class="text-muted">{{mathlib4_import|join('.')}}</code>
    {% else %}?{% endif %}</a>
</h1>

{% if data.state == PortState.PORTED%}
<div class="alert alert-success">This file has been ported!</div>
{% elif data.state == PortState.IN_PROGRESS %}
<div class="alert alert-warning">This file is currently being ported at <a href="https://github.com/leanprover-community/mathlib4/pull/{{data.status.mathlib4_pr}}">#{{data.status.mathlib4_pr}}</a>.
  {%- for label in data.labels %}
  <a class="badge rounded-pill"
     href='https://github.com/leanprover-community/mathlib4/pulls?q=is%3Apr+is%3Aopen+label%3A"{{label.name}}"'
     style="background-color:#{{label.color}};color:{{label.text_color}}">
    {{label.name}}
  </a>
  {%- endfor %}
</div>
{% endif %}
{% if data.status.comment.message is not none %}
<p>Before working on this file, consider the following:</p>
<figure>
  <blockquote class="blockquote">
    <p>{{ data.status.comment.message | htmlify_comment }}</p>
  </blockquote>
  <figcaption class="blockquote-footer">
    From <a href="https://github.com/leanprover-community/mathlib4/wiki/port-comments">the port comment wiki</a>
  </figcaption>
</figure>
{% endif %}
<script>
var range = new URLSearchParams(window.location.search).get('range');
if (range != null) {
    let [base, head] = range.split('..', 2);
    document.currentScript.insertAdjacentElement('beforebegin',
    $('<div>').addClass('alert alert-info').append(
        'You arrived at this page via a link referring to ',
        $('<code>').text(base),
        "..",
        $('<code>').text(head),
        '. These commits might no longer be shown here!'
    )[0]);
}
</script>
{% if data.forward_port is not none %}
{% set (added, removed) = data.forward_port.diff_stat %}
<h2 id="forward-port">Changes needing forward-porting</h2>
<p>The most recent change is shown first.</p>
<div>
    {%- for c in data.forward_port.commits %}
        {% set msg = c.message.split('\n', 1) %}
        <div class="row">
            <div class="col-1">{{c | link_sha}}</div>
            <div class="col-11 fw-semibold"><p>{{msg[0] | htmlify_comment}}</p></div>
            {% if msg|length > 1 %}
                <div class="col-11 offset-1">{{msg[1] | htmlify_text}}</div>
            {% endif %}
        </div>
    {%- endfor %}
    <div class="row">
        <div class="col-1">{{data.status.source | link_sha}}</div>
        <div class="col-11 text-muted"><p>(last sync)</p></div>
    </div>
</div>
<pre><code class="language-diff">{{ data.forward_port.diff }}</code></pre>
{% if data.forward_port.commits %}
<p>After forward-porting this diff, please update the SHA in the file header to <code>{{data.forward_port.commits[0].hexsha}}</code>, and include a link to this page in the PR description to help reviewers as shown:</p>
<pre><code class="lang-markdown" style="white-space: pre-wrap">* [`{{mathlib3_import|join('.')}}`@`{{data.status.source.commit}}`..`{{data.forward_port.commits[0].hexsha}}`]({{site_url}}/file/{{mathlib3_import|join('/')}}?range={{data.status.source.commit}}..{{data.forward_port.commits[0].hexsha}})
</code></pre>
<p>If they exist, also link to any forward-port PRs that already forward-ported it.</p>
{% endif %}
{% endif %}

{% set parts = data.dep_counts %}
<h2>Dependencies <small>
    {%- set plus = joiner(" + ") %}
    {%- if parts[0] -%}{{ plus() }}<span class="text-danger" title="unported">{{parts[0]}}</span>{%- endif -%}
    {%- if parts[1] -%}{{ plus() }}<span class="text-warning" title="in progress">{{parts[1]}}</span>{%- endif -%}
    {%- if parts[2] -%}{{ plus() }}<span class="text-success" title="ported">{{parts[2]}}</span>{%- endif -%}
</small></h2>
{{ progress.bars([data] + data.dependencies) }}
{% set unported_deps = ([data] + data.dependencies)|rejectattr("state", "equalto", PortState.PORTED)|list%}
{% if unported_deps %}
    <p>The unported dependencies are</p>
    <ul>
        {% for d in unported_deps %}
            <li><a href="{{ site_url }}/file/{{d.mathlib3_import|join('/')}}"><code>{{d.mathlib3_import|join('.')}}</code></a></li>
        {% endfor %}
    </ul>
    <details>
        <summary>Show graph</summary>
        <svg id="graph"></svg>
    </details>
    <script>
    const data = {{graph.subgraph(unported_deps | map(attribute='mathlib3_import') | map('join', '.')).edges() | list | tojson}};
    let svg = document.getElementById('graph');
    let has_graphed = false;
    svg.parentElement.addEventListener('toggle', () => {
        if (svg.parentElement.hasAttribute('open') && !has_graphed) {
            has_graphed = true;
            make_graph(svg, data);
        }
    })
    </script>
{%else%}
<p>All dependencies are ported!</p>
{%endif%}
{% set unsynced_deps = data.dependencies|rejectattr("forward_port", "none")|list%}
{% if unsynced_deps %}
    <p>The following {{unsynced_deps | length}} dependencies have changed in mathlib3 since they were ported, which may complicate porting this file</p>
    <ul>
        {% for d in unsynced_deps %}
            <li><a href="{{ site_url }}/file/{{d.mathlib3_import|join('/')}}"><code>{{d.mathlib3_import|join('.')}}</code></a></li>
        {% endfor %}
    </ul>
{% endif %}

{% endblock %}
